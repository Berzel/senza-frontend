import Head from "next/head";
import styled from "styled-components";
import tw from "twin.macro";
import Header from "../../components/Header/Header";
import NavBar from "../../components/NavBar/NavBar";
import Container from "../../components/Container/Container";
import { useRouter } from "next/router";
import { useState } from "react";
import CreateJobStyles from "../../components/CreateJob/CreateJob.styled";
import useUser from "../../lib/useUser";
import AuthModal from "../../components/AuthModal/AuthModal";
import axios from "axios";

const Main = styled.main`
    & > *+* {
        ${tw`mt-7 block`}
    }
`;

const NewJobPage = ({countries, sectors, jobLevels, contractTypes}) => {
    const router = useRouter();
    const { user } = useUser();
    const [showAuthModal, setShowAuthModal] = useState(false);
    const [job, setJob] = useState({});
    const [company, setCompany] = useState({});
    const [skills, setSkills] = useState(['', '', '']);
    const [responsibilities, setResponsibilities] = useState(['', '', '']);

    const updateCompany = newCompanyDetails => {
        setCompany(newCompanyDetails);
    }

    const updateJob = newJobDetails => {
        setJob(newJobDetails)
    }

    const addSkill = e => {
        e.preventDefault();
        if (skills.length > 30) return;
        const newSkills = [...skills, ''];
        setSkills(newSkills);
        updateJob({...job, qualifications: newSkills})
    }

    const updateSkill = (key, value) => {
        let newSkills = [...skills]
        newSkills[key] = value
        setSkills(newSkills)
        updateJob({...job, qualifications: newSkills})
    }

    const removeSkill = key => {
        if (skills.length <= 3) return;
        let newSkills = [...skills]
        newSkills = newSkills.filter((skill, index) => key !== index)
        setSkills(newSkills)
        updateJob({...job, qualifications: newSkills})
    }

    const addResponsibitity = e => {
        e.preventDefault()
        if (responsibilities.length > 30) return;
        const newResponsibilities = [...responsibilities, ''];
        setResponsibilities(newResponsibilities)
        updateJob({...job, responsibilities: newResponsibilities})
    }

    const updateResponsibility = (key, value) => {
        let newResponsibilities = [...responsibilities]
        newResponsibilities[key] = value
        setResponsibilities(newResponsibilities)
        updateJob({...job, responsibilities: newResponsibilities})
    }

    const removeResponsibility = key => {
        if (responsibilities.length <= 3) return;
        let newResponsibilities = [...responsibilities]
        newResponsibilities = newResponsibilities.filter((res, index) => key !== index)
        setResponsibilities(newResponsibilities)
        updateJob({...job, responsibilities: newResponsibilities})
    }
    
    const postJob = async (event) => {
        event.preventDefault()
        
        if (!user && !showAuthModal) {
            return setShowAuthModal(true)
        }

        if (user) {
            let config = {headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }};

            let company_id = company?.id ?? await axios.post(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/companies`, company, config).then(r => r.data.data.id);
            let jobDetails = await axios.post(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/jobs`, {...job, company_id}, config).then(r => r.data);
            
        }
    }
    
    return (
        <>
            <Head>
                <title>Senza - New Job</title>
                <meta name="description" content="Generated by create next app" />
            </Head>
    
            <Header>
                <div className="container">
                    <NavBar />
                </div>
            </Header>
            <Container>
                <Main>
                    <CreateJobStyles>
                        <div className="top">
                            <div>
                                <button className="back" onClick={e => router.back()}>
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M3.828 9l6.071-6.071-1.414-1.414L0 10l.707.707 7.778 7.778 1.414-1.414L3.828 11H20V9H3.828z"/>
                                        </svg>
                                    </span>
                                    <span>
                                        Back
                                    </span>
                                </button>
                            </div>
                            <h1 className="title">
                                New Job Listing
                            </h1>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Qui quo ad nostrum culpa, 
                                aperiam numquam animi enim, dolores, neque veritatis eius deleniti voluptas alias reiciendis ab dignissimos unde velit rem.
                            </p>
                        </div>
                        <div className="form-container">
                            <div className="left">
                                <div className="sidebar">
                                    Left
                                </div>
                            </div>
                            <div className="right">
                                <form action="/jobs" id="post_job_form" method="POST" encType="multipart/form-data" className="form" onSubmit={postJob}>
                                    <div className="section">
                                        <h2 className="title">
                                            Company Details
                                        </h2>
                                        <div className="row">
                                            <div className="group">
                                                <label htmlFor="name" className="label">
                                                    Company name
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="text" 
                                                    id="name" 
                                                    name="name" 
                                                    value={company?.name ?? ''} 
                                                    onChange={e => updateCompany({...company, name: e.target.value})} 
                                                    placeholder="Company name" required/>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="country_id" className="label">
                                                    Company country
                                                </label>
                                                <select 
                                                    className="input" 
                                                    id="country_id" 
                                                    value={company?.country_id ?? '1'} 
                                                    onChange={e => updateCompany({...company, country_id: e.target.value})} 
                                                    name="country_id" required>
                                                        {
                                                            countries && countries.map(country => (
                                                                <option key={country.id} value={country.id}>{country.name}</option>
                                                            ))
                                                        }
                                                </select>
                                            </div>
                                        </div>
                                        <div className="group">
                                            <label htmlFor="about" className="label">
                                                About your company
                                            </label>
                                            <textarea 
                                                rows="5" 
                                                className="input" 
                                                name="about" 
                                                id="about" 
                                                value={company?.about ?? ''} 
                                                onChange={e => updateCompany({...company, about: e.target.value})} 
                                                placeholder="What is your company all about?" required>
                                            </textarea>
                                        </div>
                                        <div className="row">
                                            <div className="group">
                                                <label htmlFor="website" className="label">
                                                    Company website
                                                </label>
                                                <input 
                                                    type="url" 
                                                    className="input"
                                                    id="website" 
                                                    name="website" 
                                                    value={company?.website ?? ''}
                                                    onChange={e => updateCompany({...company, website: e.target.value})}
                                                    placeholder="www.company.com"/>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="contact_email" className="label">
                                                    Contact email
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="email" 
                                                    id="contact_email" 
                                                    name="contact_email"
                                                    value={company?.contact_email ?? ''}
                                                    onChange={e => updateCompany({...company, contact_email: e.target.value})} 
                                                    placeholder="someone@company.com"/>
                                            </div>
                                        </div>
                                        <div className="row">
                                            <div className="group">
                                                <label htmlFor="twitter_handle" className="label">
                                                    Twitter handle
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="text" 
                                                    id="twitter_handle" 
                                                    name="twitter_handle"
                                                    value={company?.twitter_handle ?? ''}
                                                    onChange={e => updateCompany({...company, twitter_handle: e.target.value})} 
                                                    placeholder="@CompanyName"/>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="facebook_page" className="label">
                                                    Facebook
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="text" 
                                                    id="facebook_page" 
                                                    name="facebook_page"
                                                    value={company?.facebook_page ?? ''}
                                                    onChange={e => updateCompany({...company, facebook_page: e.target.value})} 
                                                    placeholder="Company facebook page"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="section">
                                        <h2 className="title">
                                            Job Details
                                        </h2>
                                        <div className="row">
                                            <div className="group">
                                                <label htmlFor="title" className="label">
                                                    Job title / role
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="text" 
                                                    id="title" 
                                                    name="title" 
                                                    value={job?.title ?? ''} 
                                                    onChange={e => updateJob({...job, title: e.target.value})} 
                                                    placeholder="Web Developer, etc" required/>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="sector_id" className="label">
                                                    Industry sector
                                                </label>
                                                <select 
                                                    className="input" 
                                                    name="sector_id" 
                                                    value={job?.sector_id ?? ''}
                                                    onChange={e => updateJob({...job, sector_id: e.target.value})}
                                                    id="sector_id" required>
                                                        {
                                                            sectors && sectors.map(sector => (
                                                                <option key={sector.id} value={sector.id}>{sector.display_name}</option>
                                                            ))
                                                        }
                                                </select>
                                            </div>
                                        </div>
                                        <div className="row">
                                            <div className="group">
                                                <label htmlFor="level_id" className="label">
                                                    Job level
                                                </label>
                                                <select 
                                                    className="input" 
                                                    name="level_id"
                                                    value={job?.level_id ?? ''}
                                                    onChange={e => updateJob({...job, level_id: e.target.value})}
                                                    id="level_id" required>
                                                        {
                                                            jobLevels && jobLevels.map(level => (
                                                                <option key={level.id} value={level.id}>{level.display_name}</option>
                                                            ))
                                                        }
                                                </select>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="contract_type_id" className="label">
                                                    Contract type
                                                </label>
                                                <select 
                                                    className="input" 
                                                    name="contract_type_id"
                                                    value={job?.contract_type_id ?? ''}
                                                    onChange={e => updateJob({...job, contract_type_id: e.target.value})} 
                                                    id="contract_type_id" required>
                                                        {
                                                            contractTypes && contractTypes.map(type => (
                                                                <option key={type.id} value={type.id}>{type.display_name}</option>
                                                            ))
                                                        }
                                                </select>
                                            </div>
                                        </div>
                                        <div className="group">
                                            <label htmlFor="description" className="label">
                                                Job description
                                            </label>
                                            <textarea 
                                                rows="8" 
                                                className="input" 
                                                name="description" 
                                                id="description"
                                                value={job?.description ?? ''}
                                                onChange={e => updateJob({...job, description: e.target.value})} 
                                                placeholder="Job description goes here" required/>
                                        </div>

                                        <div>
                                            <h3 className="small-title">Salary details</h3>
                                            <div className="check-group">
                                                <input 
                                                    type="checkbox" 
                                                    name="negotiable"
                                                    checked={!!job?.salary?.negotiable} 
                                                    onChange={e => updateJob({...job, salary: {...job?.salary, negotiable: e.target.checked}})}
                                                    id="negotiable"/>
                                                <label htmlFor="negotiable" className="check-label">Salary is negotiable?</label>
                                            </div>
                                            <div className="row">
                                                <div className="group">
                                                    <label htmlFor="salary.min" className="label">
                                                        Min
                                                    </label>
                                                    <input 
                                                        className="input" 
                                                        type="number" 
                                                        id="salary.min" 
                                                        name="salary.min" 
                                                        value={job?.salary?.min ?? ''}
                                                        onChange={e => updateJob({...job, salary: {...job?.salary, min: e.target.value}})}
                                                        placeholder="250" required/>
                                                </div>
                                                <div className="group">
                                                    <label htmlFor="salary.max" className="label">
                                                        Max
                                                    </label>
                                                    <input 
                                                        className="input" 
                                                        type="number"
                                                        id="salary.max" 
                                                        name="salary.max" 
                                                        value={job?.salary?.max ?? ''}
                                                        onChange={e => updateJob({...job, salary: {...job?.salary, max: e.target.value}})}
                                                        placeholder="10000" required/>
                                                </div>
                                                <div className="group">
                                                    <label htmlFor="salary.currency" className="label">
                                                        Currency
                                                    </label>
                                                    <select 
                                                        className="input" 
                                                        name="salary.currency" 
                                                        value={job?.salary?.currency ?? ''}
                                                        onChange={e => updateJob({...job, salary: {...job?.salary, currency: e.target.value}})}
                                                        id="salary.currency" required>
                                                            <option value="usd">USD</option>
                                                            <option value="zwl">ZWL</option>
                                                            <option value="eur">EUR</option>
                                                            <option value="gbp">GBP</option>
                                                    </select>
                                                </div>
                                                <div className="group">
                                                    <label htmlFor="salary.period" className="label">
                                                        Interval
                                                    </label>
                                                    <select 
                                                        className="input" 
                                                        name="salary.period"
                                                        value={job?.salary?.period ?? ''}
                                                        onChange={e => updateJob({...job, salary: {...job?.salary, period: e.target.value}})} 
                                                        id="salary.period" required>
                                                            <option value="hourly">Hourly</option>
                                                            <option value="daily">Daily</option>
                                                            <option value="weekly">Weekly</option>
                                                            <option value="bi-weekly">Bi-Weekly</option>
                                                            <option value="monthly">Monthly</option>
                                                            <option value="yearly">Yearly</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="small-title">Residential preference</h3>
                                            <div className="check-group">
                                                <input 
                                                    type="checkbox" 
                                                    name="is_remote"
                                                    checked={!!job?.is_remote} 
                                                    onChange={e => updateJob({...job, is_remote: e.target.checked})} 
                                                    id="is_remote" />
                                                <label htmlFor="is_remote" className="check-label">This role allows working from home?</label>
                                            </div>
                                            <div className="row">
                                                <div className="group">
                                                    <label htmlFor="country_id" className="label">
                                                        Country
                                                    </label>
                                                    <select 
                                                        className="input" 
                                                        name="country_id" 
                                                        value={job?.country_id ?? '1'}
                                                        onChange={e => updateJob({...job, country_id: e.target.value})}
                                                        id="country_id">
                                                            {
                                                                countries && countries.map(country => (
                                                                    <option key={country.id} value={country.id}>{country.name}</option>
                                                                ))
                                                            }
                                                    </select>
                                                </div>
                                                <div className="group">
                                                    <label htmlFor="city" className="label">
                                                        City / Town
                                                    </label>
                                                    <input 
                                                        className="input" 
                                                        type="text" 
                                                        id="city" 
                                                        name="city" 
                                                        value={job?.city ?? ''}
                                                        onChange={e => updateJob({...job, city: e.target.value})}
                                                        placeholder="Enter town or city name"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="sub-section">
                                            <h3 className="small-title">Responsibilities</h3>
                                            {
                                                responsibilities && responsibilities.map((res, key) => (
                                                    <div className="group list" key={key}>
                                                        <input 
                                                            className="input" 
                                                            value={res} 
                                                            onChange={e => updateResponsibility(key, e.target.value)} 
                                                            type="text" 
                                                            id={`responsibilities[${key}]`} 
                                                            name={`responsibilities[${key}]`} 
                                                            placeholder={`Responsibility #${key+1}`} required/>
                                                        {
                                                            key >= 3 && <a href="#" className="remove-btn" onClick={e => {e.preventDefault(); removeResponsibility(key)}}>x</a>
                                                        }
                                                    </div>
                                                ))
                                            }
                                            <div className="more-btn">
                                                <a href="#" onClick={addResponsibitity}>
                                                    +
                                                </a>
                                            </div>
                                        </div>
                                        <div className="sub-section">
                                            <h3 className="small-title">Skills &amp; Qualifications</h3>
                                            {
                                                skills && skills.map((skill, key) =>(
                                                    <div className="group list" key={key}>
                                                        <input 
                                                            className="input" 
                                                            value={skill} 
                                                            onChange={e => updateSkill(key, e.target.value)} 
                                                            type="text" 
                                                            id={`qualifications[${key}]`} 
                                                            name={`qualifications[${key}]`} 
                                                            placeholder={`Qualification #${key+1}`} required/>
                                                        {
                                                            key >= 3 && <a href="#" className="remove-btn" onClick={e => {e.preventDefault(); removeSkill(key)}}>x</a>
                                                        }
                                                    </div>
                                                ))
                                            }
                                            <div className="more-btn">
                                                <a href="#" onClick={addSkill}>
                                                    +
                                                </a>
                                            </div>
                                        </div>
                                        <div className="sub-section">
                                            <h3 className="small-title">How to apply</h3>
                                            <div className="group">
                                                <label htmlFor="application_instructions" className="label">
                                                    Application instructions
                                                </label>
                                                <textarea 
                                                    rows="5" 
                                                    className="input" 
                                                    name="application_instructions" 
                                                    id="application_instructions"
                                                    value={job?.application_instructions ?? ''}
                                                    onChange={e => updateJob({...job, application_instructions: e.target.value})} 
                                                    placeholder="How should candidates apply?" required/>
                                            </div>
                                            <div className="row">
                                            <div className="group">
                                                <label htmlFor="application_email" className="label">
                                                    Application email
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="email"
                                                    id="application_email" 
                                                    name="application_email"
                                                    value={job?.application_email ?? ''}
                                                    onChange={e => updateJob({...job, application_email: e.target.value})} 
                                                    placeholder="Application email"/>
                                            </div>
                                            <div className="group">
                                                <label htmlFor="application_link" className="label">
                                                    Application link
                                                </label>
                                                <input 
                                                    className="input" 
                                                    type="url"
                                                    id="application_link" 
                                                    name="application_link"
                                                    value={job?.application_link ?? ''}
                                                    onChange={e => updateJob({...job, application_link: e.target.value})} 
                                                    placeholder="Application link"/>
                                            </div>
                                            </div>
                                        </div>
                                        <div className="group">
                                            <input type="submit" className="input submit" name="action" value="Post your job" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        { showAuthModal && (<AuthModal close={() => setShowAuthModal(false)} />) }
                    </CreateJobStyles>
                </Main>
            </Container>
        </>
    )
}

export default NewJobPage

export async function getStaticProps(context) {
    const countries = await axios.get(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/countries/all`).then(r => r.data)
    const sectors = await axios.get(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/sectors/all`).then(r => r.data)
    const jobLevels = await axios.get(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/levels/all`).then(r => r.data)
    const contractTypes = await axios.get(`${process.env.NEXT_PUBLIC_CORE_SERVICE_ENDPOINT}/contract-types/all`).then(r => r.data)

    return {
        props: {
            countries,
            sectors,
            jobLevels,
            contractTypes
        },
    }
}